'use strict';
const getUrlFromCssText = require('./getUrlFromCssText');
const uniq = require('./uniq');

// NOTE this code is very similar to the node part of visual-grid-client, but there is a different related to the browser's cssom with import rules
function makeExtractResourcesFromStyleSheet({styleSheetCache}) {
  return function extractResourcesFromStyleSheet(styleSheet, win = window) {
    return uniq(
      [...styleSheet.cssRules].reduce((acc, rule) => {
        if (rule instanceof win.CSSImportRule) {
          styleSheetCache[rule.styleSheet.href] = rule.styleSheet;
          return acc.concat(rule.href);
        } else if (rule instanceof win.CSSFontFaceRule) {
          return acc.concat(getUrlFromCssText(rule.style.getPropertyValue('src')));
        } else if (rule instanceof win.CSSSupportsRule || rule instanceof win.CSSMediaRule) {
          return acc.concat(extractResourcesFromStyleSheet(rule));
        } else if (rule instanceof win.CSSStyleRule) {
          for (let i = 0, ii = rule.style.length; i < ii; i++) {
            const urls = getUrlFromCssText(rule.style.getPropertyValue(rule.style[i]));
            urls.length && (acc = acc.concat(urls));
          }
        }
        return acc;
      }, []),
    );
  };
}

module.exports = makeExtractResourcesFromStyleSheet;
